<h1>Diễn biến trận đấu</h1>

<?php
require_once 'config.php';
require_once 'html_form_helper.php';
startMySQLConnection();
?>

<form name="frmC" id="frmC" method="post" action="">
	<input type="hidden" name="hdnUpdateId" />
	<input type="hidden" name="hdnDeleteId" />
	<input type="hidden" name="hdnAddCommand" value="0" />
	<?php
//get choosed match id
	if (isset($_POST["hdnDetailId"]) & $_POST["hdnDetailId"] != ""  & $_POST["hdnDetailId"] != null) {
		$_SESSION["choosedMatchID"] = $_POST["hdnDetailId"];
	}
		$matchId = $_SESSION["choosedMatchID"];
echo "ID".$matchId;
// Handle Update
	if (isset($_POST["hdnUpdateId"]) && $_POST["hdnUpdateId"] > 0) {
		$id = $_POST["hdnUpdateId"];
		$sql = "Update match_events set `name` = '" . $_POST["txtName_" . $id] . "' Where id=" . $id;
		mysql_query($sql);
	}
// Handle Delete
	if (isset($_POST["hdnDeleteId"]) && $_POST["hdnDeleteId"] > 0) {
		$id = $_POST["hdnDeleteId"];
		$sql = "Delete From `match_events` Where id=" . $id;
		mysql_query($sql);
	}
// Handle Add new:
	if (isset($_POST["hdnAddCommand"]) && $_POST["hdnAddCommand"] > 0) {
		$name = $_POST["sltTeamMember"];
		$minute = $_POST["sltMinute"];
		$event = $_POST["sltEventType"];
		$desc = $_POST["txtAddDescription"];
//		$name = $_POST["txtAddName"];
//		if ($name == null || $name == "") {
//			echo "<font color='red'>Vui lòng nhập tên quốc gia</font>";
//		} else {
		$sql = "Insert Into match_events(eventTime, eventTypeId, teamMemberId, eventDescription, matchId) Values($minute, $event, $name, '" . $desc . "', $matchId )";
		echo "ADD" . $sql;
		
		mysql_query($sql);
//		}
	}

//id 	eventTime 	eventTypeId 	teamMemberId 	eventDescription 
// List match_events by name
	//$filterByName = $_POST["txtFilterByName"];
	$sql = "
	SELECT match_events.id, eventTime AS time, eventtypes.name AS event, teammembers.name, eventDescription AS description
FROM `match_events` , eventtypes, teammembers
WHERE match_events.eventTypeId = eventtypes.id
AND teamMemberId = teammembers.id
        " .
		($matchId != null && $matchId != "" ? " And match_events.matchId = " . $matchId : "") .
	   	" Order By `eventTime` Asc";
echo $sql;
	$result = mysql_query($sql);
	?>
	<table>
		<tr>
			<td>
				Lọc:
			</td>
			<td>
				<input type="text" name="txtFilterByName" value="<?php echo($filterByName); ?>" />
				<input type="submit" name="btnFilter" value="Lọc" />
			</td>
		</tr>
	</table>

	<table style="border: solid activecaption thin;">
		<tr style="background-color: activecaption;">
			<td><b>Id</b></td>
			<td><b>Thời gian (phút)</b></td>
			<td><b>Sự kiện</b></td>
			<td><b>Cầu thủ</b></td>
			<td><b>Mô tả</b></td>
			<td>&nbsp;</td>
		</tr>
		<tr style="background-color: #dcdcdc;">
			<td></td>
			<td>
				Thêm sự kiện: 
				<select name="sltMinute">
					<?php
					for ($i = 1; $i <= 120; $i++) {
						echo '<option value=' . $i . ">" . $i . "</option>";
					}
					?>	
				</select>
			</td>
			<td>
				<select name="sltEventType">
					<?php printAllSelectOptionsFromTable("eventtypes"); ?>
				</select>
			</td>

			<td>
				<select name="sltTeamMember">
					<?php printAllSelectOptionsFromTable("teammembers"); ?>
				</select>
			</td>
			<td>
				<input type="text" name="txtAddDescription">
			</td>
			<td>

				<input type="button" name="btnAddNew" value="Thêm mới" 
				       onclick="
					       frmC.hdnAddCommand.value='1'; 
					       frmC.submit();
				       " 
				       />
			</td>
		</tr>
		<?php
		$i = 0;
		while ($r = mysql_fetch_array($result)) {
			$cId = $r["id"];
			?>
			<tr style="background-color: <?php echo($i % 2 == 0 ? "white" : "#f5f5f5"); ?>">
				<td><?php echo($r["id"]); ?></td>
				<td><?php echo($r["time"]); ?></td>
				<td><?php echo($r["event"]); ?></td>
				<td>
					<input type="text" 
					       name="txtName_<?php echo($cId); ?>" 
					       value="<?php echo($r["name"]); ?>"
					       style="border:none; width: 100%; background-color: inherit;"
					       />
				</td>
				<td><?php echo($r["description"]); ?></td>

				<td nowrap="true">
					<input type="button" 
					       name="btnUpdate_<?php echo($cId); ?>"
					       onclick="
						       frmC.hdnUpdateId.value='<?php echo($cId); ?>';
						       frmC.submit();
					       "
					       value="Lưu lại"
					       />
					<input type="button" 
					       name="btnDelete_<?php echo $cId; ?>"
					       onclick="
						       if (confirm('Bạn chắc chắn muốn xóa?')) {
							       frmC.hdnDeleteId.value='<?php echo($cId); ?>';
							       frmC.submit();
						       }
					       "
					       value="Xóa"
					       />
				</td>
			</tr>
			<?php
			$i++;
		}
		?>
	</table>
</form>
